<p>– 查出2020年高于订单平均金额的订单数量、订单总金额<br>select<br>    count(1) as ‘订单数量’,<br>    sum(order_payment) as ‘订单总金额’<br>from<br>    mall_unit_order<br>where<br>    order_payment &gt; (select avg(order_payment) from mall_unit_order)</p>
<p>/*<br>    定义：<br>        购买两单以及以上的用户为复购用户，同一用户相邻两单的支付间隔天数为复购间隔天数。<br>    计算每一个复购用户在2020年的平均复购间隔天数<br>    解题：<br>        当初被“同一用户相邻两单的支付间隔天数为复购间隔天数”给迷惑了，计算复购天数的逻辑就是计算首次下单时间与最后一次下单时间的差值然后除以订单的数量</p>
<p>*/</p>
<p>with base as (<br>    – 2020年的所有订单信息<br>    select<br>        *<br>    from<br>        mall_unit_order<br>    where<br>        pay_time &gt;= ‘2020-01-01’ and pay_time &lt; ‘2021-01-01’<br>    ORDER BY pay_time<br>),<br>user_filtered_base as (<br>    – 购买两单以上的用户的信息<br>    select<br>        *,<br>        DATEDIFF(date(pay_time), first_pay_time) as diff – 日期差<br>    from (<br>        select<br>            *,<br>            count(*) over (partition by buyer_nick) as order_num,<br>            min(date(pay_time)) over (partition by buyer_nick) as first_pay_time – 第一次购买时间<br>        from<br>            base<br>    ) as a<br>    where<br>        a.order_num &gt;= 2<br>)</p>
<p>select<br>    buyer_nick,<br>    ceil(max(diff) / (order_num - 1)) as ‘平均复购间隔天数’ – 向上取整<br>from<br>    user_filtered_base<br>group by<br>    buyer_nick</p>
<p>/*</p>
<p> 按月查出2020年3月份各个省份支付金额排在前3的城市在哪里</p>
<p>*/<br>with base as (<br>    select<br>        province,<br>        city,<br>        sum(order_payment) as pay_num<br>    from<br>        mall_unit_order<br>    where month(pay_time) = 7<br>    group by<br>        province, city<br>)<br>select<br>    province,<br>    city<br>from (</p>
<p>select<br>    *,<br>    row_number() over (partition by province order by pay_num desc) as ranking<br>from base<br>) as a<br>where ranking &lt;= 3<br>order by province, ranking</p>
<p>/*<br>    假设下单渠道有京东、天猫、淘宝，查出2020年3月份各个渠道订单支付总金额<br>*/</p>
<p>select<br>    order_source,<br>    sum(order_payment) as ‘支付总金额’<br>from<br>    mall_unit_order<br>where<br>    pay_time between ‘2020-07-01’ and ‘2020-07-31’<br>group by<br>    order_source</p>
<p>/*<br>    查出最近三个月内有购买行为的用户信息，包括字段：<br>        唯一用户ID，<br>        用户号码，<br>        支付订单数，<br>        支付总金额，<br>        支付总件数，<br>        最近一次购买时间<br>        常用收货省份，<br>        常用收货城市，<br>    用户ID中间5位数用<em>代替<br><em>/<br>with base as (<br>    select<br>        *<br>    from<br>        mall_unit_order<br>),<br>user_province as (<br>    select<br>        buyer_nick,<br>        province<br>    from (<br>        select<br>            buyer_nick,<br>            province,<br>            row_number() over (partition by buyer_nick order by num desc) as ranking<br>        from (<br>            select<br>                buyer_nick,<br>                province,<br>                count(</em>) as num<br>            from<br>                base<br>            group by<br>                buyer_nick, province<br>            order by<br>                buyer_nick, num desc<br>        ) as a<br>    ) as a<br>    where ranking = 1<br>),<br>user_city as (<br>    select<br>        buyer_nick,<br>        city<br>    from (<br>        select<br>            buyer_nick,<br>            city,<br>            row_number() over (partition by buyer_nick order by num desc) as ranking<br>        from (<br>            select<br>                buyer_nick,<br>                city,<br>                count(</em>) as num<br>            from<br>                base<br>            group by<br>                buyer_nick, city<br>            order by<br>                buyer_nick, num desc<br>        ) as a<br>    ) as a<br>    where ranking = 1<br>)</p>
<p>select<br>    a.<em>,<br>    b.province as ‘省份’,<br>    c.city as ‘城市’<br>from (<br>    select<br>        buyer_nick,<br>        concat(left(buyer_mobile, 3), ‘*****’, right(buyer_mobile, 3)) as ‘手机号’,<br>        count(</em>) as ‘支付订单数’,<br>        sum(order_payment) as ‘支付总金额’,<br>        sum(buy_num)  as ‘支付总件数’,<br>        max(pay_time) as ‘最近一次购买时间’<br>    from<br>        base<br>    group by<br>        buyer_nick<br>) as a<br>left join user_province as b<br>on b.buyer_nick = a.buyer_nick </p>
<p>left join user_city as c<br>on c.buyer_nick = a.buyer_nick</p>
