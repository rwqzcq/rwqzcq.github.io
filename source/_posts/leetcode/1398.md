---
title: 1398. 购买了产品 A 和产品 B 却没有购买产品 C 的顾客
date: 2021-09-24 14:21:37
tags:
 - SQL
categories:
 - Leetcode
---

# 题目描述

```TXT
 Customers 表：

+---------------------+---------+
| Column Name         | Type    |
+---------------------+---------+
| customer_id         | int     |
| customer_name       | varchar |
+---------------------+---------+
customer_id 是这张表的主键。
customer_name 是顾客的名称。
 

Orders 表：

+---------------+---------+
| Column Name   | Type    |
+---------------+---------+
| order_id      | int     |
| customer_id   | int     |
| product_name  | varchar |
+---------------+---------+
order_id 是这张表的主键。
customer_id 是购买了名为 "product_name" 产品顾客的id。
 

请你设计 SQL 查询来报告购买了产品 A 和产品 B 却没有购买产品 C 的顾客的 ID 和姓名（ customer_id 和 customer_name ），我们将基于此结果为他们推荐产品 C 。
您返回的查询结果需要按照 customer_id 排序。

 

查询结果如下例所示。

Customers table:
+-------------+---------------+
| customer_id | customer_name |
+-------------+---------------+
| 1           | Daniel        |
| 2           | Diana         |
| 3           | Elizabeth     |
| 4           | Jhon          |
+-------------+---------------+

Orders table:
+------------+--------------+---------------+
| order_id   | customer_id  | product_name  |
+------------+--------------+---------------+
| 10         |     1        |     A         |
| 20         |     1        |     B         |
| 30         |     1        |     D         |
| 40         |     1        |     C         |
| 50         |     2        |     A         |
| 60         |     3        |     A         |
| 70         |     3        |     B         |
| 80         |     3        |     D         |
| 90         |     4        |     C         |
+------------+--------------+---------------+

Result table:
+-------------+---------------+
| customer_id | customer_name |
+-------------+---------------+
| 3           | Elizabeth     |
+-------------+---------------+
只有 customer_id 为 3 的顾客购买了产品 A 和产品 B ，却没有购买产品 C 。

来源：力扣（LeetCode）
链接：https://leetcode-cn.com/problems/customers-who-bought-products-a-and-b-but-not-c
著作权归领扣网络所有。商业转载请联系官方授权，非商业转载请注明出处。
```

# 错误写法

```sql
select
    customer_id,
    customer_name
from
    Customers
where
    customer_id in (
        select
            distinct customer_id
        from
            Orders
        where
            product_name = 'A' and product_name = 'B' and (product_name != 'C')
    )
```

> 把所有的过滤条件全部写在一个where里面没效果，因为where是对所有的行挨个遍历，相当于在写`for`循环体中进行过滤。
> 上述的写法相当于某一行的名字既等于A，又等于B，同时不等于C

而这个题的逻辑应该是

> 对customer_id进行聚合操作 -> 找到既包含A，又包含B的，却没有C的

# 正确写法

```sql
select
    customer_id,
    customer_name
from 
    Customers
where
    customer_id in (
        select
            customer_id
        from
            orders
        group by
            customer_id
        having
            sum(product_name = 'A') >= 1 and
            sum(product_name = 'B') >= 1 and
            sum(product_name = 'C') = 0
    )
```
