---
title: 6月1日实习内容
date: 2021-06-01 16:12:54
tags:
 - 金山实习
categories:
 - 金山实习
---

# Add Home Screen相关指标计算

## 版本

13.8

## 日期

0409到0429这20天的数据。

## 具体业务流程
1. 用户打开某一个文档。
2. 若该文档满足某一个触发条件，则弹窗提示用户添加到桌面一个链接。
3. 用户可以点击`ok`，`not now`或者`空白处`。
4. 用户可以选择从首页打开这个文档。

## 相关指标
1. 找到这20天内，20天的openfile的uv
```sql
declare start_date default '0409';
declare end_date default '0429';

with base as (
    select
        event_date,
        user_pseudo_id,
        (SELECT value.string_value FROM UNNEST(event_params) WHERE key='comp') as comp, # 组件
    from 
        `wps-cloud-service.analytics_153386958.events_2021*`
    where 
        _table_suffix >= start_date and _table_suffix <= end_date and
        event_name = 'comp_openfile' and
        app_info.version = '13.8'
)
select
    event_date,
    comp,
    count(distinct user_pseudo_id) as uv
from base
group by
    event_date,
    comp
order by event_date, comp
```

这个计算的结果的话发现日期不对，结果比较奇怪的是event_date是从20210417到20210429,从4月9日到16号之间无数据。

> 原因是在于这个event表只会保留45天的所有记录

2. 弹窗的uv
```sql
declare start_date default '0409';
declare end_date default '0429';

select
    event_date,
    case 
        when lower(comp)  like '%doc%' then 'DOC'
        when lower(comp) like '%ppt%' then 'PPT'
        when lower(comp) like '%xls%' then 'ET'
        when lower(comp) like '%et%' then 'ET'
        when lower(comp) like '%pdf%' then 'PDF'
        else 'other'
    end as comp,
    position,
    count(distinct user_pseudo_id) as uv
from (
    select
        event_date,
        user_pseudo_id,
        (SELECT value.string_value FROM UNNEST(event_params) WHERE key='comp') as comp, -- 组件
        (SELECT value.string_value FROM UNNEST(event_params) WHERE key='position') as position -- 触发方式
    from
        `wps-cloud-service.analytics_153386958.events_2021*`
    where 
        _table_suffix >= start_date and _table_suffix <= end_date and
        event_name = 'page_show' and
        app_info.version = '13.8' and
        (SELECT value.string_value FROM UNNEST(event_params) WHERE key='func_name') = 'add_homescreen_show'
) as a
group by
    event_date, comp, position
order by
    event_date, comp, position
```

3. 从桌面打开的uv

```sql
declare start_date default '0409';
declare end_date default '0429';
with base as (
    select
        event_date,
        user_pseudo_id,
        (SELECT value.string_value FROM UNNEST(event_params) WHERE key='comp') as comp, # 组件
    from 
    `wps-cloud-service.analytics_153386958.events_2021*`
    where 
        _table_suffix >= start_date and _table_suffix <= end_date and
        event_name = 'comp_openfile' and
        app_info.version = '13.8' and
        (select value.string_value from unnest(event_params) where key='source') = 'homescreen'
)

select
    event_date,
    comp,
    count(distinct user_pseudo_id) as uv
from base
group by
    event_date,
    comp
order by 
    event_date,
    comp
```

4. click的uv

```sql
declare start_date default '0409';
declare end_date default '0429';

with click_add_base as (
    select
        event_date,
        user_pseudo_id,
        (SELECT value.string_value FROM UNNEST(event_params) WHERE key='data1') as if_ok, # 是否添加成功
        (SELECT value.string_value FROM UNNEST(event_params) WHERE key='comp') as comp, # 组件
        (SELECT value.string_value FROM UNNEST(event_params) WHERE key='stat') as if_ask_agagin, # 表示是否勾选了Dont ask me again
        (SELECT value.string_value FROM UNNEST(event_params) WHERE key='position') as position # 触发方式
    from
        `wps-cloud-service.analytics_153386958.events_2021*`
    where 
        _table_suffix >= start_date and _table_suffix <= end_date and
        event_name = 'button_click' and
        app_info.version = '13.8' and
        (SELECT value.string_value FROM UNNEST(event_params) WHERE key='func_name') = 'add_homescreen_add'
),
click_no_base as (
    select
        event_date,
        user_pseudo_id,
        (SELECT value.string_value FROM UNNEST(event_params) WHERE key='data1') as if_ok, # 是否添加成功
        (SELECT value.string_value FROM UNNEST(event_params) WHERE key='comp') as comp, # 组件
        (SELECT value.string_value FROM UNNEST(event_params) WHERE key='stat') as if_ask_agagin, # 表示是否勾选了Dont ask me again
        (SELECT value.string_value FROM UNNEST(event_params) WHERE key='position') as position # 触发方式
    from
        `wps-cloud-service.analytics_153386958.events_2021*`
    where 
        _table_suffix >= start_date and _table_suffix <= end_date and
        event_name = 'button_click' and
        app_info.version = '13.8' and
        (SELECT value.string_value FROM UNNEST(event_params) WHERE key='func_name') = 'add_homescreen_no'
),
click_add as (
    select
        'click_add' as click_name,
        event_date,
        # case 
        #     when lower(comp)  like '%doc%' then 'DOC'
        #     when lower(comp) like '%ppt%' then 'PPT'
        #     when lower(comp) like '%xls%' then 'ET'
        #     when lower(comp) like '%et%' then 'ET'
        #     when lower(comp) like '%pdf%' then 'PDF'
        #     else 'other'
        # end as comp,
        comp,
        position,
        if_ask_agagin,
        if_ok,
        count(distinct user_pseudo_id) as uv
    from
        click_add_base 
    group by 
        event_date,
        comp,
        position,
        if_ask_agagin,
        if_ok
    order by
        event_date,
        comp,
        position,
        if_ask_agagin,
        if_ok
),
click_no as (
    select
        'click_no' as click_name,
        event_date,
        # case 
        #     when lower(comp)  like '%doc%' then 'DOC'
        #     when lower(comp) like '%ppt%' then 'PPT'
        #     when lower(comp) like '%xls%' then 'ET'
        #     when lower(comp) like '%et%' then 'ET'
        #     when lower(comp) like '%pdf%' then 'PDF'
        #     else 'other'
        # end as comp,
        comp,
        position,
        if_ask_agagin,
        if_ok,
        count(distinct user_pseudo_id) as uv
    from
        click_no_base 
    group by 
        event_date,
        comp,
        position,
        if_ask_agagin,
        if_ok
    order by
        event_date,
        comp,
        position,
        if_ask_agagin,
        if_ok  
)

select * from click_add 
union all (select * from click_no)
order by 
    click_name,
    event_date,
    comp,
    position,
    if_ask_agagin,
    if_ok

```
> 需要注意的是这个里面的comp，取的是文件的后缀名，而不是没有归类成`ET`, `DOC`这样的。

comp有如下形式

```txt
文件后缀	文档类型
CSV	ET
DOC	DOC
DOCX	DOC
PDF	PDF
PPS	PPT
PPSX	PPT
PPT	PPT
PPTX	PPT
RTF	other
S	other
TXT	other
XLS	ET
XLSM	ET
XLSX	ET
XML	other
asp	other
c	other
cpp	other
docm	DOC
dot	DOC
dotx	DOC
dps	PPT
dpt	PPT
et	ET
htm	other
html	other
java	other
log	other
lrc	other
mhtml	other
potx	PPT
pptm	PPT
wps	DOC
xlsb	ET
xlt	ET
xltx	ET
pot	PPT
xltm	ET
asm	other
bat	other
dotm	DOC
mht	other
ppsm	PPT
wpt	DOC
cmd	other
ett	ET
h	other
other	other
```

如果要映射成`ET`、`PPT`这种形式的话在excel里面我使用的方法是:
>为每一个标准的文档类型编号，从0开始，然后使用`if`函数嵌套来完成组件的替换。

但是更快捷的方式是使用`VLOOKUP`,vlookup(查找的值, 要查找的区域, 要返回的列(在查找区域内)的索引(从1开始)， 是否精确查找)