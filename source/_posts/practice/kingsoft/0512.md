---
title: 5月12日工作内容
date: 2021-05-12 10:32:00
tags:
 - 实习
categories:
 - 金山实习
---

# 工作内容

1. 继续学习Leader做的数据复盘，
2. 分版本计算留存率变化。

# 分版本计算周留存

计算每一个国家每一个版本上线的2周内的留存变化。

结果1 - 大盘

![](/images/wps_retention_version_excel.png)

已经知道了每一个版本的日期范围，计算这个日期范围内该`版本`与`大盘`的留存率。
步骤为
1. 根据日期筛选出该日期内大盘的week0与week1。
```excel
SUMIFS(data!$E:$E,data!$C:$C,$L$10,data!$B:$B,$L$11,data!$A:$A,">="&$I17,data!$A:$A,"<="&$J17)/SUMIFS(data!$D:$D,data!$C:$C,$L$10,data!$B:$B,$L$11,data!$A:$A,">="&$I17,data!$A:$A,"<="&$J17)
```
核心就是日期的判断用`data!$A:$A,">="&$I17`，要注意用`双引号`在做字符串的拼接的时候。

但是在做这个的时候就出现了很大的问题，就在于写SQL的时候并没有做`根据不同的版本计算周留存`。后来检查SQL还发现了日本也没有分版本，
原来是把泰国分版本的SQL复制成日本的时候`参数并没有做更改`!

```sql
with base_version as (
    -- 大盘分版本
    select 
        week,
        left(first_open_version, 4) as version, -- 这里需要注意
        'all' as country,
        week_interval,
        sum(retentions) as retentions
    from
        `wps-data-analysis.wps_metric_android.android_retentions_weekly`
    where
        week >= "2021-02-15" and
        week_interval in (0, 1) and
        first_open_version >= '13.0' and first_open_version <= '14.0.0'
    group by version, week, week_interval
    order by version, week, week_interval
)
```

2. 根据日期筛选出该日期内版本的week0与week1。
```excel
SUMIFS(data!$E:$E,data!$C:$C,$L$10,data!$B:$B,$K17,data!$A:$A,">="&$I17,data!$A:$A,"<="&$J17)/SUMIFS(data!$D:$D,data!$C:$C,$L$10,data!$B:$B,$K17,data!$A:$A,">="&$I17,data!$A:$A,"<="&$J17)
```

# 分国家计算月留存（不区分版本）

1. 写sql

```sql
-- 月留存
with base as (
    -- 大盘
    select
        month,
        month_interval,
        'all' as country,
        sum(retentions) as retentions
    from 
        `wps-data-analysis.wps_metric_android.android_retentions_monthly`
    where month_interval in (0, 1)
    group by month, month_interval 
    order by month, month_interval
),
Japan_base as (
    -- 日本
    select
        month,
        month_interval,
        'Japan' as country,
        sum(retentions) as retentions
    from 
        `wps-data-analysis.wps_metric_android.android_retentions_monthly`
    where month_interval in (0, 1) and country in ('Japan')
    group by month, month_interval 
    order by month, month_interval
),
Thailand_base as (
    -- 泰国
    select
        month,
        month_interval,
        'Thailand' as country,
        sum(retentions) as retentions
    from 
        `wps-data-analysis.wps_metric_android.android_retentions_monthly`
    where month_interval in (0, 1) and country in ('Thailand')
    group by month, month_interval 
    order by month, month_interval
),
month_all as (
    select * from base
    union all (select * from Japan_base)
    union all (select * from Thailand_base)
    order by country, month, month_interval
),
month0 as (
    select * from month_all where month_interval = 0
),
month1 as (
    select * from month_all where month_interval = 1
)

select
    a.month,
    a.country,
    a.retentions as month0,
    b.retentions as month1
from month0 as a
inner join month1 as b
on a.month = b.month and a.country = b.country
order by country, month

```

2. 结果导出到excel
3. sumifs + $计算留存
在`$绝对引用`那里还是不是很熟练。
```excel
SUMIFS(data!$O:$O,data!$L:$L,$B4,data!$M:$M,C$2)/SUMIFS(data!$N:$N,data!$L:$L,$B4,data!$M:$M,C$2)
```
> 下拉的时候date要向下(行)顺延，向右(列)不发生变化，也就是`$B4` 行变列不变，$在前面。
> 右拉的时候date(行)不变化，而向右(列)发生变化，也就是`C$2`，行不变列变，$在中间。


# 学习的知识点

1. excel & 符号的使用

> &符号代表字符串的拼接

在时间周期那里得到`20201124-20201206`这样的格式。
```excel
text(I7, 'YYYYMMDD') & '-' & text(I8, 'YYYYMMDD')
```
2. excel $ 地址引用

