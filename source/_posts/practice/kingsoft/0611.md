---
title: 6月11日实习内容
date: 2021-06-11 11:38:21
tags:
 - 实习
categories:
 - 金山实习
---

# 分别取出来list2_thumbnail部分中实验组与对照组的留存

```sql

with
    base as (
        select
            DISTINCT parse_DATE('%Y%m%d',event_date) AS date,
            user_pseudo_id AS google_id,
            ( SELECT value.string_value FROM UNNEST(user_properties) WHERE key='firebase_exp_231') as exp
        from
            `wps-cloud-service.analytics_153386958.events_202105*`
        where 
            _table_suffix >= '01' and _table_suffix <= '31' and
            event_name = 'button_click' and
            ( SELECT value.string_value FROM UNNEST(event_params) WHERE key='button_name')  = 'thumbnail2_list'
            and  ( SELECT value.string_value FROM UNNEST(user_properties) WHERE key='firebase_exp_231') is not null -- 命中了
    ),
    yesterday as (
        select * from base
    ),
    today as (
        select * from base
    )

select
    date_trunc(a.date, week) as week, 
    a.exp as exp,
    date_diff(b.date, a.date, week) as time_interval, 
    count(distinct b.google_id) as retention
from 
    yesterday a
inner join 
    today b
on 
    a.google_id = b.google_id 
    and date_diff(b.date, a.date, week) in (0,1)
group by  
    week, 
    a.exp, 
    time_interval
order by 
    week, 
    exp, 
    time_interval
```

> `( SELECT value.string_value FROM UNNEST(user_properties) WHERE key='firebase_exp_231')` is not null这个只能代表实验有没有命中，而区分对照组与实验组的标识是`0`与`1`