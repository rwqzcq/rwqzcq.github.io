---
title: 5月31日实习内容
date: 2021-05-31 14:34:17
tags:
 - 实习
categories:
 - 金山实习
---

# 日本本地化-首页视觉优化:AB实验取数

```sql
--捞取firebase中215号ab实验的两组用户的次日留存率 
WITH
  yesterday AS ( (
    SELECT
      DISTINCT parse_DATE('%Y%m%d',
        event_date) AS date,
       ( SELECT value.string_value FROM UNNEST(user_properties) WHERE key='firebase_exp_231') as exp,--区分实验组和对照组用户
      user_pseudo_id AS google_id
    FROM
      `wps-cloud-service.analytics_153386958.events_*`
    WHERE
      _table_suffix >= '20210409'and _table_suffix <= '20210429'
      and ( SELECT value.string_value FROM UNNEST(user_properties) WHERE key='firebase_exp_231') is not null 
      AND event_name IN ('user_engagement')
      AND app_info.version ='13.8'
      and geo.country in ('Japan')
       ) ),
  today AS ( (
   select distinct date, google_id
from `wps-data-analysis.wps_active.user_engagement_v3`
where date >= '2021-04-09'and  date <= '2021-04-29'))
--以上为子查询，限定了ab实验的当日用户和次日活跃的用户

SELECT--捞取次日留存，将子查询中的两个表进行join，计算留存率
  DATE_TRUNC(a.date, day),
  a.exp,
  DATE_DIFF(b.date, a.date, day) AS time_interval,
  COUNT(DISTINCT b.google_id) AS retention
FROM
  yesterday a
INNER JOIN
  today b
ON
  a.google_id = b.google_id
  AND DATE_DIFF(b.date, a.date, day) >=0
  AND DATE_DIFF(b.date, a.date, day) <=15
GROUP BY
  a.date,
  a.exp,
  time_interval 
```

一定要注意限定条件：

- 版本
- 国家
- 日期

一般取版本上线后的第4天到第21天，也就是数据较为平稳的阶段。

# excel透视表的优劣势

## 优势
- 能够快速集合数据，直接进行求和，调整参数也很方面。

## 劣势
- 扩展性较差，当需要区分不同维度画图的时候，需要复制多次，复制值得同时就是值复制，而不是引用复制。
- 需要手动更新，当原始数据更换的时候，就不得不进行手动点击`更新数据源`，因此在需要做多条件选择数据并画图的时候，最好是用`sumifs`函数加上`$绝对引用`。

## 经验

> 用excel做到智能化，只需要贴数据就能运行，而不是在发现查询出来的数据错误，从而从头再来画图的时候，就需要提前布局好要画的图以及列的表格，然后用`定位函数`来做。