---
title: 5月18日实习内容
date: 2021-05-18 11:20:35
tags:
 - 实习
categories:
 - 金山实习
---

# 埋点

## 概念
数据埋点就是在APP端，记录某一些行为的数据采集机制。根据用户在APP上的一系列操作线索，提炼有用的信息，进行数据分析。

## 应用
1. 分析运营机制合理性
比如记录APP分享的转化率

2. 产品功能的合理性
提前在新功能的各个按钮上进行埋点，就能获取到用户使用新功能的次数，以及在新功能的使用行为，可以分析用户是否对新功能比较感兴趣，页面的跳转设置是否合理等。

3. 分析用户消费行为，挖掘流失点
记录到每个流程的转化率，用于分析用户漏斗的哪一个阶段出现了问题，结合业务输出解决方案。

4. 监控产品的流畅性
提前在核心功能页面和按钮进行埋点，就能记录到每个页面和按钮的衔接情况，发现问题及时解决，以免影响用户体验。

5. 分析不同渠道的用户行为差异
提前在各个渠道进行埋点，记录各渠道用户在APP中的后续行为，调整推广策略。

## 埋点类型
1. 页面埋点
用户进入一次页面就上报一次，页面埋点主要用来记录用户访问某个页面的各项信息，可自定义触发时间、获取要求以及页面来源。

2. 点击埋点
点击埋点主要用来记录用户在某个页面点击某个按钮／广告位／ｂａｎｎｅｒ等的各项信息，可自定义触发时间、获取要求以及页面来源。

3. 停留埋点
停留埋点主要用来记录用户访问某个页面的停留时长的各项信息，同样可自定义触发时间、获取要求以及页面来源。
用于分析不同渠道的喜好情况对比。

## 编写埋点需求
1. 产品流程图

2. 实录场景思路

3. 编写文档

文档三要素：
- 用户属性信息，比如说需要获取用户的设备号、标签、定位什么的；
- 事件ID，是事件埋点的唯一标识，每一条埋点记录对应一个事件ID，用于在数据库进行取数；
- 事件描述，包括事件类型（点击／页面／停留）、事件来源（如果产品逻辑复杂，可以多级来源，１级来源、２级来源等）、触发时间、触发事件（让计算机知道什么情况要触发）    


# 安卓数据埋点规范

## 目前埋点出现的问题

1. 各个PM埋点规范不统一
2. 变量命名不规范
3. 新人培训成本高

## 埋点文档示例

![埋点文档规范1](maidian-1.png)

![埋点文档规范](maidian-2.png)

总体上来说，主要就是让安卓APP的埋点在命名上具有统一的格式与可解读性。基础的埋点类型有三个，分别是
- button-click 点击
- page-show 页面展示
- func_result 功能结果

每一个埋点都是一个事件，每一个事件都有`名字`，一系列属性与属性所对应的值，不同的事件从总体上看，都要有某一些通用的属性，如下图所示。

![事件通用属性](event-common-keys.png)


# 具体表结构

该事件表为一个`宽表`，不同于传统的mysql数据库一行就是一个数据，而这个宽表就类似与一种JSON的格式，如下面的图：
```JSON
[
    {'id': 1, 'params': [{
        'key1': 'func_name',
        'value': '1'
    }]}
]
```
该宽表内可以先按照日期来截取整个表的内容，然后再进行查询数据，其中最主要的函数是`unnest`。
比如下面的sql

```sql
select
    *
from
    `wps-cloud-analysis.analytics.enents_2021*`
where
    event_name = 'btn_click' and
    _table_suffix >='0214' and -- 日期查询
    (select value.string_value from unnest(params) where key='category') = 'Memo'
```

# SQL练习

## 计算Memo这个功能4月份以来13.9版本的周留存

```sql
with base04 as (
    select
        *
    from 
        `wps-cloud-service.analytics_153386958.events_202104*`
    where
        app_info.version >= '13.9' and 
        event_name ='page_show' and
        (select value.string_value from unnest(event_params) where key='category') = 'Memo'
    order by event_date
),
base05 as (
    select
        *
    from 
        `wps-cloud-service.analytics_153386958.events_202105*`
    where
        app_info.version >= '13.9' and 
        event_name ='page_show' and
        (select value.string_value from unnest(event_params) where key='category') = 'Memo'
    order by event_date 
),
base as (
    select * from base04
    union all (select * from base05)
    order by event_date
),
yesterday as (
    select
        distinct parse_DATE('%Y%m%d', event_date) as date,
        user_pseudo_id as google_id
    from
        base
),
today as (
    select
        distinct parse_DATE('%Y%m%d', event_date) as date,
        user_pseudo_id as google_id
    from
        base
)
-- 计算总体周留存
select 
    date_trunc(a.date, week) as week,
    date_diff(b.date, a.date, week) as week_interval,
    count(distinct a.google_id) as retentions
from yesterday as a
inner join today as b
on a.google_id = b.google_id and
date_diff(b.date, a.date, week) in (0, 1)
group by 
    week,
    week_interval
order by
    week,
    week_interval
```

# 埋点面试题目


# 参考链接
1. 数据埋点介绍：https://zhuanlan.zhihu.com/p/38282055
