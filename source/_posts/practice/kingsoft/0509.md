---
title: 5月9日工作内容
date: 2021-05-10 11:20:32
tags:
categories:
 - 金山实习
---

# 工作内容

1. 周留存， 用weekly那张表 ，拆分大盘、日本、泰国；
2. 拆分预装和主动安装的，同时配合体量来看；
3. 已知主动安装的留存率跟openfile强相关，捞取用户openfile的占比和频次变化；

# 分析

1. 总体难度：比较简单，底层逻辑已经写好，只需要去对应的表里面去取数据就好。
2. 需要注意：拼写，`unkonwn` != `unkonwn`。
3. Excel数据透视表的使用。
4. hive 中union all操作会讲数据的顺序打乱，因此需要在最后面加上`order`。

# sql

## 总体周留存

```sql
with Japan as (
    select
        week,
        time_interval,
        sum(retention_devices) as retention,
        'Japan' as country
    from 
        `wps-data-analysis.wps_active.android_retentions_weekly`
    where
        week >= '2021-03-01' and 
        country in ('Japan') and 
        time_interval in (0, 1)
    group by week, time_interval
    order by week
),
Thailand as (
    select
        week,
        time_interval,
        sum(retention_devices) as retention,
        'Thailand' as country
    from 
        `wps-data-analysis.wps_active.android_retentions_weekly`
    where
        week >= '2021-03-01' and 
        country in ('Thailand') and 
        time_interval in (0, 1)
    group by week, time_interval
    order by week
),
Base as (
    select
        week,
        time_interval,
        sum(retention_devices) as retention_devices,
        'base' as country
    from 
        `wps-data-analysis.wps_active.android_retentions_weekly`
    where
        week >= '2021-03-01' and 
        time_interval in (0, 1)
    group by week, time_interval
    order by week
)

select
    *
from 
    Base

union ALL
(
   select * from Japan 
   order by week
)
union ALL
(
   select * from Thailand  
   order by week
)
order by country, week

```

## 区分预装非预装

```sql

# 拆分大盘、日本、泰国
# 拆分主动还是预装

with Japan as (
    select
        is_oem,
        week,
        time_interval,
        sum(retention_devices) as retention,
        '日本' as country,
    from (
        select 
            week,
            time_interval,
            retention_devices,
            case when wps_channel_oem in ('unknown') then 0 when wps_channel_oem is null then 0 else 1 end as is_oem
        from 
            `wps-data-analysis.wps_active.android_retentions_weekly`
        where 
            week >= '2021-03-01' and 
            country in ('Japan') and 
            time_interval in (0, 1)
        order by week
    ) as a
    group by is_oem, week, time_interval
    order by is_oem, week
),
Thailand as (
    select
        is_oem,
        week,
        time_interval,
        sum(retention_devices) as retention,
        '泰国' as country,
    from (
        select 
            week,
            time_interval,
            retention_devices,
            case when wps_channel_oem in ('unknown') then 0 when wps_channel_oem is null then 0 else 1 end as is_oem
        from 
            `wps-data-analysis.wps_active.android_retentions_weekly`
        where 
            week >= '2021-03-01' and 
            country in ('Thailand') and 
            time_interval in (0, 1)
        order by week
    ) as a
    group by is_oem, week, time_interval
    order by is_oem, week    
),
Base as (
    select
        is_oem,
        week,
        time_interval,
        sum(retention_devices) as retention,
        '大盘' as country,
    from (
        select 
            week,
            time_interval,
            retention_devices,
            case when wps_channel_oem in ('unkonwn') then 0 when wps_channel_oem is null then 0 else 1 end as is_oem
        from 
            `wps-data-analysis.wps_active.android_retentions_weekly`
        where 
            week >= '2021-03-01' and 
            time_interval in (0, 1)
        order by week
    ) as a
    group by is_oem, week, time_interval
    order by is_oem, week
)

select
    *
from 
    Base
union ALL
    (
    select * from Japan
    )
union ALL
    (
    select * from Thailand  
    )
order by
    country, is_oem, week

```

## 捞取用户openfile的占比和频次变化

```sql
SELECT  
    date,
    sum(if_view)
FROM 
    `wps-data-analysis.wps_active.android_core_feature_view_edit` 
WHERE
    date >= '2021-03-01' and
    (wps_channel_oem = 'unknown' or wps_channel_oem is null)
group by 
    date
order by date
```